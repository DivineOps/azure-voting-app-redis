
resources:
  containers:
  - container: myACRContainer  
    type: ACR
    subscription: RMPM
    registry: 'raireg1.azurecr.io'
    image: zenithworksazurevotingappredis

resources:
- repo: self

variables:
  system.debug: 'true'
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: 'raireg1'
  imageRepository: 'zenithworksazurevotingappredis'
  containerRegistry: 'raireg1.azurecr.io'
  dockerfilePath: '**/Dockerfile'
  tag: '$(Build.BuildId)'
  imagePullSecret: 'raireg11795044f-auth'

- stage: Deploy
  displayName: Deploy stage  
  jobs:
  - deployment: Deploy
    displayName: Deploy
    pool: 'igniteDemoPool'
    environment: 'zenithworksazurevotingappredis.ignitedemo1'
    strategy:
      canary:
        increments: [25]
        preDeploy:
          steps:
          - script:
              echo $(strategy.name)
              
        deploy:
          steps:
          - script: |
              echo Strategy: $(strategy.name)
              echo Increment: $(strategy.increment)
          
        postRouteTraffic:
          pool: server
          steps:
            - script: echo Running Canary Analysis task
        on:
          failure:
            steps:
            - script: echo deployment failed...
            
          success:
            steps:
            - script: echo deployment succeeded...              
            
